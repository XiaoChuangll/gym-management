<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>关于项目 | 健身房管理系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style type="text/tailwindcss">
        @layer utilities {
            .card-hover {
                transition: all 0.3s;
                &:hover {
                    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
                    transform: translateY(-0.25rem);
                }
            }
            .tech-badge {
                display: inline-flex;
                align-items: center;
                padding-left: 0.75rem;
                padding-right: 0.75rem;
                padding-top: 0.25rem;
                padding-bottom: 0.25rem;
                border-radius: 9999px;
                font-size: 0.875rem;
                font-weight: 500;
            }
            .pulse {
                animation: pulse 2s infinite;
            }
            .update-item {
                border-left-width: 4px;
                border-left-color: rgb(59, 130, 246);
                padding-left: 1rem;
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
                margin-bottom: 0.75rem;
            }
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.5; }
                100% { opacity: 1; }
            }
            .fade-in {
                animation: fadeIn 0.5s ease-in;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
<!-- 响应式导航栏 -->
<header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <!-- Logo -->
        <a th:href="@{/}" class="flex items-center space-x-2">
            <i class="fa fa-dumbbell text-blue-600 text-2xl"></i>
            <span class="text-xl font-bold">健身房管理系统</span>
        </a>

        <!-- 桌面导航（隐藏于移动端） -->
        <nav class="hidden md:flex space-x-6">
            <a th:href="@{/index}" class="hover:text-blue-600">首页</a>
            <a th:href="@{https://github.com/XiaoChuangll/gym-management}" class="hover:text-blue-600" target="_blank">
                <i class="fa fa-github mr-1"></i>GitHub
                <!-- GitHub星标计数（仅桌面端显示） -->
                <span id="github-stars" class="ml-1 bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded-full pulse">
                    <i class="fa fa-star"></i> 加载中...
                </span>
            </a>
            <a href="#" class="text-blue-600 font-medium">关于项目</a>
        </nav>

        <!-- 移动端汉堡按钮（仅移动端显示） -->
        <button id="mobile-menu-button" class="md:hidden text-gray-600 focus:outline-none">
            <i class="fa fa-bars text-2xl"></i>
        </button>
    </div>

    <!-- 移动端菜单（下拉式） -->
    <div id="mobile-menu" class="md:hidden h-0 overflow-hidden transition-all duration-300 bg-white">
        <div class="container mx-auto px-4 flex flex-col space-y-2 pb-3">
            <a th:href="@{/index}" class="py-2 hover:text-blue-600 border-b border-gray-100">首页</a>
            <a th:href="@{https://github.com/XiaoChuangll/gym-management}" class="py-2 hover:text-blue-600 border-b border-gray-100" target="_blank">
                <i class="fa fa-github mr-1"></i>GitHub
                <!-- GitHub星标计数（移动端） -->
                <span id="github-stars-mobile" class="ml-1 bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded-full pulse">
                    <i class="fa fa-star"></i> 加载中...
                </span>
            </a>
            <a href="#" class="py-2 text-blue-600 font-medium border-b border-gray-100">关于项目</a>
        </div>
    </div>
</header>

<!-- 项目介绍主内容 -->
<main class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- 项目标题和简介 -->
    <section class="text-center mb-12">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">健身房管理系统</h1>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto">
            一个基于Spring Boot的现代化健身房管理解决方案，助力健身房数字化运营
        </p>
        <!-- 版本信息 -->
        <div class="mt-6 inline-flex items-center px-4 py-2 bg-blue-50 text-blue-700 rounded-full text-sm">
            <span class="font-medium">当前版本:</span>
            <span id="latest-version" class="ml-1 pulse">加载中...</span>
            <a href="https://github.com/XiaoChuangll/gym-management/releases"
               target="_blank"
               class="ml-2 text-blue-500 hover:text-blue-700">
                <i class="fa fa-external-link"></i>
            </a>
        </div>
    </section>

    <!-- 最新更新内容 -->
    <section class="mb-16">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
            <i class="fa fa-history mr-2 text-blue-600"></i>最新更新
            <button id="refresh-updates" class="ml-3 text-blue-500 hover:text-blue-700 text-sm">
                <i class="fa fa-refresh"></i> 刷新
            </button>
        </h2>

        <div class="bg-white rounded-xl shadow-md p-6">
            <div id="updates-loading" class="text-center py-8">
                <div class="inline-flex items-center px-4 py-2 bg-gray-100 rounded-full">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mr-2"></div>
                    <span>正在获取更新内容...</span>
                </div>
            </div>

            <div id="updates-content" class="hidden">
                <!-- 这里会动态填充更新内容 -->
            </div>

            <div id="updates-error" class="hidden text-center py-8 text-red-600">
                <i class="fa fa-exclamation-triangle text-2xl mb-2"></i>
                <p>无法获取更新内容，请稍后重试</p>
                <button onclick="loadUpdates()" class="mt-3 text-blue-600 hover:text-blue-800 text-sm">
                    <i class="fa fa-refresh mr-1"></i>重新加载
                </button>
            </div>
        </div>
    </section>

    <!-- 项目特色 -->
    <section class="mb-16">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">项目特色</h2>
        <div class="grid md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-md card-hover">
                <div class="text-blue-600 text-3xl mb-4">
                    <i class="fa fa-users"></i>
                </div>
                <h3 class="text-xl font-semibold mb-2">会员全周期管理</h3>
                <p class="text-gray-600">从入会登记、会籍管理到训练记录跟踪，完整覆盖会员生命周期</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md card-hover">
                <div class="text-blue-600 text-3xl mb-4">
                    <i class="fa fa-calendar-check-o"></i>
                </div>
                <h3 class="text-xl font-semibold mb-2">智能预约系统</h3>
                <p class="text-gray-600">可视化课程排期，支持微信端自主预约，降低人工管理成本</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md card-hover">
                <div class="text-blue-600 text-3xl mb-4">
                    <i class="fa fa-bar-chart"></i>
                </div>
                <h3 class="text-xl font-semibold mb-2">数据可视化分析</h3>
                <p class="text-gray-600">实时生成经营报表，会员活跃度、课程满员率等关键指标一目了然</p>
            </div>
        </div>
    </section>

    <!-- 技术架构 -->
    <section class="mb-16">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">技术架构</h2>
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-gray-200">
                <!-- 后端技术 -->
                <div class="p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-server text-blue-600 mr-2"></i>后端技术栈
                    </h3>
                    <ul class="space-y-3">
                        <li class="flex items-center">
                            <a href="https://spring.io/projects/spring-boot" target="_blank" class="tech-badge bg-green-100 text-green-800 hover:bg-green-200 transition-colors">
                                Spring Boot 3.1.5
                            </a>
                            <span class="ml-2 text-gray-600">核心框架</span>
                        </li>
                        <li class="flex items-center">
                            <a href="https://spring.io/projects/spring-security" target="_blank" class="tech-badge bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors">
                                Spring Security
                            </a>
                            <span class="ml-2 text-gray-600">权限控制</span>
                        </li>
                        <li class="flex items-center">
                            <a href="https://hibernate.org" target="_blank" class="tech-badge bg-purple-100 text-purple-800 hover:bg-purple-200 transition-colors">
                                Hibernate 6
                            </a>
                            <span class="ml-2 text-gray-600">ORM框架</span>
                        </li>
                        <li class="flex items-center">
                            <a href="https://www.mysql.com" target="_blank" class="tech-badge bg-amber-100 text-amber-800 hover:bg-amber-200 transition-colors">
                                MySQL 8.0
                            </a>
                            <span class="ml-2 text-gray-600">数据库</span>
                        </li>
                    </ul>
                </div>

                <!-- 前端技术 -->
                <div class="p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-desktop text-blue-600 mr-2"></i>前端技术栈
                    </h3>
                    <ul class="space-y-3">
                        <li class="flex items-center">
                            <a href="https://www.thymeleaf.org" target="_blank" class="tech-badge bg-cyan-100 text-cyan-800 hover:bg-cyan-200 transition-colors">
                                Thymeleaf
                            </a>
                            <span class="ml-2 text-gray-600">模板引擎</span>
                        </li>
                        <li class="flex items-center">
                            <a href="https://tailwindcss.com" target="_blank" class="tech-badge bg-indigo-100 text-indigo-800 hover:bg-indigo-200 transition-colors">
                                Tailwind CSS
                            </a>
                            <span class="ml-2 text-gray-600">UI框架</span>
                        </li>
                        <li class="flex items-center">
                            <a href="https://www.chartjs.org" target="_blank" class="tech-badge bg-pink-100 text-pink-800 hover:bg-pink-200 transition-colors">
                                Chart.js
                            </a>
                            <span class="ml-2 text-gray-600">数据可视化</span>
                        </li>
                        <li class="flex items-center">
                            <a href="https://fontawesome.com" target="_blank" class="tech-badge bg-gray-100 text-gray-800 hover:bg-gray-200 transition-colors">
                                Font Awesome
                            </a>
                            <span class="ml-2 text-gray-600">图标库</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <!-- 项目信息 -->
    <section class="mb-16">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">项目信息</h2>
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="p-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-3">开发信息</h3>
                        <ul class="space-y-2 text-gray-600">
                            <li class="flex">
                                <span class="w-24 font-medium">开发者：</span>
                                <span>XiaoChuangll</span>
                            </li>
                            <li class="flex">
                                <span class="w-24 font-medium">版本：</span>
                                <span id="version-info" class="pulse">加载中...</span>
                            </li>
                            <li class="flex">
                                <span class="w-24 font-medium">许可证：</span>
                                <span>MIT License</span>
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-3">代码仓库</h3>
                        <div class="space-y-2">
                            <a href="https://github.com/XiaoChuangll/gym-management"
                               target="_blank"
                               class="inline-flex items-center text-blue-600 hover:underline">
                                <i class="fa fa-github mr-2"></i>
                                GitHub仓库
                                <span id="repo-stars" class="ml-2 bg-yellow-100 text-yellow-800 text-xs px-2 py-0.5 rounded-full pulse">
                                    <i class="fa fa-star"></i> 加载中...
                                </span>
                            </a>
                            <div class="flex items-center text-gray-600">
                                <i class="fa fa-code-fork mr-2"></i>
                                <span>主要分支：main</span>
                            </div>
                            <div class="flex items-center text-gray-600">
                                <i class="fa fa-eye mr-2"></i>
                                <span id="repo-watchers">加载中...</span>
                                <span class="ml-2">人关注</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 我的 GitHub 仓库 -->
    <section id="my-github" class="mb-16">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center justify-between">
            <span class="inline-flex items-center"><i class="fa fa-github mr-2 text-gray-800"></i>我的 GitHub 项目</span>
            <button id="repos-toggle" class="md:hidden inline-flex items-center text-sm text-blue-600 hover:text-blue-800" aria-expanded="true">
                收起 <i class="fa fa-chevron-up ml-1"></i>
            </button>
        </h2>
        <div id="repos-section" class="bg-white rounded-xl shadow-md p-4 sm:p-6 overflow-hidden">
            <div id="repos-loading" class="text-center py-8">
                <div class="inline-flex items-center px-4 py-2 bg-gray-100 rounded-full">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mr-2"></div>
                    <span>正在获取仓库列表...</span>
                </div>
            </div>
            <div id="repos-error" class="hidden text-center py-8 text-red-600">
                <i class="fa fa-exclamation-triangle text-2xl mb-2"></i>
                <p>无法获取仓库列表，请稍后重试</p>
                <button id="repos-retry" class="mt-3 text-blue-600 hover:text-blue-800 text-sm">
                    <i class="fa fa-refresh mr-1"></i>重新加载
                </button>
            </div>
            <div id="repos-grid" class="grid grid-cols-1 gap-6 md:grid-cols-3 auto-rows-fr"></div>
            <div class="text-center mt-6">
                <a id="repos-more" href="#" target="_blank" class="inline-flex items-center text-blue-600 hover:underline">
                    <i class="fa fa-external-link mr-2"></i>在 GitHub 上查看更多
                </a>
            </div>
        </div>
    </section>

    <!-- GitHub 贡献图 -->
    <section id="github-contrib" class="mb-16">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center">
            <i class="fa fa-calendar mr-2 text-blue-600"></i>GitHub 贡献图
        </h2>
        <div class="bg-white rounded-xl shadow-md p-4 sm:p-6 overflow-hidden">
            <div id="contrib-loading" class="text-center py-8">
                <div class="inline-flex items-center px-4 py-2 bg-gray-100 rounded-full">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mr-2"></div>
                    <span>正在加载贡献图...</span>
                </div>
            </div>
            <div id="contrib-error" class="hidden text-center py-8 text-red-600">
                <i class="fa fa-exclamation-triangle text-2xl mb-2"></i>
                <p>无法加载贡献图，请稍后重试</p>
                <button id="contrib-retry" class="mt-3 text-blue-600 hover:text-blue-800 text-sm">
                    <i class="fa fa-refresh mr-1"></i>重新加载
                </button>
            </div>
            <div id="contrib-graph-wrap" class="hidden">
                <img id="contrib-graph" alt="GitHub 贡献图" class="block w-full max-w-full h-auto rounded-lg select-none pointer-events-none" referrerpolicy="no-referrer" />
                <div class="text-right mt-2">
                    <a id="contrib-source" href="#" target="_blank" class="text-xs text-gray-500 hover:text-gray-700 underline">在 GitHub 查看</a>
                </div>
            </div>
        </div>
    </section>
</main>

<!-- 页脚 -->
<footer class="bg-gray-50 border-t border-gray-200 py-8 mt-12">
    <div class="container mx-auto px-4">
        <div class="flex flex-col md:flex-row justify-between items-center">
            <!-- 版权信息 -->
            <div class="mb-4 md:mb-0 text-center md:text-left">
                <div class="flex items-center justify-center md:justify-start space-x-2 mb-2">
                    <i class="fa fa-dumbbell text-blue-600 text-xl"></i>
                    <span class="text-lg font-semibold text-gray-800">健身房管理系统</span>
                </div>
                <p class="text-sm text-gray-500 mb-2">© 2025 版权所有 | MIT License</p>
                <p class="text-xs text-gray-400">当前版本: <span id="footer-version" class="pulse">加载中...</span> | 最后更新: <span id="last-updated">加载中...</span></p>
            </div>

            <!-- 社交链接 -->
            <div class="flex flex-col items-center md:items-end space-y-2">
                <div class="flex space-x-4">
                    <a href="https://github.com/XiaoChuangll/gym-management"
                       target="_blank"
                       class="text-gray-500 hover:text-blue-600 transition-colors relative"
                       title="GitHub仓库">
                        <i class="fa fa-github text-xl"></i>
                        <span id="footer-stars" class="absolute -top-2 -right-3 bg-blue-100 text-blue-800 text-xs px-1.5 py-0.5 rounded-full pulse">
                            ...
                        </span>
                    </a>
                    <a href="mailto:your-email@example.com"
                       class="text-gray-500 hover:text-blue-600 transition-colors"
                       title="联系我们">
                        <i class="fa fa-envelope text-xl"></i>
                    </a>
                    <a href="#"
                       class="text-gray-500 hover:text-blue-600 transition-colors"
                       title="文档中心">
                        <i class="fa fa-book text-xl"></i>
                    </a>
                </div>
                <a href="https://github.com/XiaoChuangll/gym-management/issues"
                   target="_blank"
                   class="text-xs text-blue-600 hover:underline">
                    报告问题或建议
                </a>
            </div>
        </div>
    </div>
</footer>

<script>
    // GitHub仓库信息获取
    const repoOwner = 'XiaoChuangll';
    const repoName = 'gym-management';

    // 格式化日期
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Markdown 渲染（marked + DOMPurify）
    function renderMarkdown(md) {
        if (!md) return '暂无详细说明';
        try {
            return DOMPurify.sanitize(marked.parse(md));
        } catch (e) {
            console.error('Markdown 解析失败:', e);
            return DOMPurify.sanitize(String(md).replace(/\n/g, '<br>'));
        }
    }

    // 获取更新内容
    async function loadUpdates() {
        const loadingEl = document.getElementById('updates-loading');
        const contentEl = document.getElementById('updates-content');
        const errorEl = document.getElementById('updates-error');

        // 显示加载状态
        loadingEl.classList.remove('hidden');
        contentEl.classList.add('hidden');
        errorEl.classList.add('hidden');

        try {
            // 获取最新发布
            const releasesResponse = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/releases`);
            let releases = [];
            if (releasesResponse.ok) {
                releases = await releasesResponse.json();
            }

            // 获取最新提交
            const commitsResponse = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/commits?per_page=5`);
            let commits = [];
            if (commitsResponse.ok) {
                commits = await commitsResponse.json();
            }

            // 渲染更新内容
            renderUpdates(releases, commits);

            // 显示内容
            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');

        } catch (error) {
            console.error('获取更新内容失败:', error);
            loadingEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
        }
    }

    // 渲染更新内容
    function renderUpdates(releases, commits) {
        const contentEl = document.getElementById('updates-content');
        let html = '';

        // 如果有发布版本
        if (releases.length > 0) {
            html += `
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-green-700 flex items-center">
                        <i class="fa fa-tag mr-2"></i>最新发布
                    </h3>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <h4 class="font-semibold text-green-800">${releases[0].name || releases[0].tag_name}</h4>
                        <p class="text-sm text-green-600 mb-2">发布于 ${formatDate(releases[0].published_at)}</p>
                        <div class="prose prose-sm max-w-none text-green-700">
                            ${renderMarkdown(releases[0].body)}
                        </div>
                        <a href="${releases[0].html_url}" target="_blank" class="inline-block mt-2 text-sm text-green-600 hover:text-green-800">
                            <i class="fa fa-external-link mr-1"></i>查看详情
                        </a>
                    </div>
                </div>
            `;
        }

        // 显示最新提交（支持折叠）
        if (commits.length > 0) {
            html += `
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-blue-700 flex items-center">
                        <i class="fa fa-code-commit mr-2"></i>最近提交
                        <button id="commits-toggle" class="ml-auto inline-flex items-center text-sm text-blue-600 hover:text-blue-800" aria-expanded="true">收起 <i class="fa fa-chevron-up ml-1"></i></button>
                    </h3>
                    <div id="commits-list">
            `;

            commits.forEach(commit => {
                html += `
                    <div class="update-item fade-in">
                        <div class="flex justify-between items-start mb-1">
                            <strong class="text-gray-800">${commit.commit.message.split('\n')[0]}</strong>
                            <span class="text-xs text-gray-500">${formatDate(commit.commit.author.date)}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-1">作者: ${commit.commit.author.name}</p>
                        <a href="${commit.html_url}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800">
                            <i class="fa fa-external-link mr-1"></i>查看提交
                        </a>
                    </div>
                `;
            });

            html += `</div></div>`;
        }

        // 如果没有内容
        if (!html) {
            html = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fa fa-info-circle text-2xl mb-2"></i>
                    <p>暂无更新内容</p>
                </div>
            `;
        }

        contentEl.innerHTML = html;

        // 绑定“最近提交”折叠事件（桌面和移动端都可用）
        const commitsToggle = document.getElementById('commits-toggle');
        const commitsList = document.getElementById('commits-list');
        if (commitsToggle && commitsList) {
            commitsToggle.addEventListener('click', () => {
                const expanded = commitsToggle.getAttribute('aria-expanded') === 'true';
                if (expanded) {
                    commitsList.classList.add('hidden');
                    commitsToggle.setAttribute('aria-expanded', 'false');
                    commitsToggle.innerHTML = '展开 <i class="fa fa-chevron-down ml-1"></i>';
                } else {
                    commitsList.classList.remove('hidden');
                    commitsToggle.setAttribute('aria-expanded', 'true');
                    commitsToggle.innerHTML = '收起 <i class="fa fa-chevron-up ml-1"></i>';
                }
            });
        }
    }

    // 加载并展示用户的 GitHub 仓库
    async function loadUserRepos() {
        const gridEl = document.getElementById('repos-grid');
        const loadingEl = document.getElementById('repos-loading');
        const errorEl = document.getElementById('repos-error');
        const moreLink = document.getElementById('repos-more');
        if (moreLink) moreLink.href = `https://github.com/${repoOwner}?tab=repositories`;

        // 显示加载，隐藏错误与内容
        if (loadingEl) loadingEl.classList.remove('hidden');
        if (errorEl) errorEl.classList.add('hidden');
        if (gridEl) gridEl.innerHTML = '';

        try {
            const res = await fetch(`https://api.github.com/users/${repoOwner}/repos?per_page=100&type=owner&sort=updated`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            let repos = await res.json();

            // 只展示非 fork 仓库，按 star 数排序，取前 9 个
            repos = repos
                .filter(r => !r.fork)
                .sort((a, b) => b.stargazers_count - a.stargazers_count)
                .slice(0, 9);

            if (!gridEl) return;

            if (repos.length === 0) {
                gridEl.innerHTML = '<div class="col-span-full text-center text-gray-500">暂无仓库</div>';
            } else {
                gridEl.innerHTML = repos.map(repo => {
                    const desc = repo.description ? repo.description.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '暂无描述';
                    const lang = repo.language || '未标注';
                    const updated = new Date(repo.updated_at).toLocaleDateString('zh-CN');
                    return `
                        <a href="${repo.html_url}" target="_blank" class="block w-full bg-white p-4 sm:p-5 rounded-xl shadow-md card-hover border border-gray-100 fade-in h-full">
                            <div class="flex items-center justify-between mb-2 min-w-0">
                                <h3 class="font-semibold text-gray-800 truncate flex-1 min-w-0" title="${repo.name}"><i class="fa fa-code-fork text-gray-400 mr-2"></i>${repo.name}</h3>
                                <span class="text-xs bg-yellow-50 text-yellow-800 px-2 py-0.5 rounded-full flex-shrink-0"><i class="fa fa-star mr-1"></i>${repo.stargazers_count}</span>
                            </div>
                            <p class="text-sm text-gray-600 truncate mb-3" title="${desc}">${desc}</p>
                            <div class="flex items-center text-xs text-gray-500 space-x-4">
                                <span><i class="fa fa-code mr-1"></i>${lang}</span>
                                <span title="最后更新"><i class="fa fa-clock-o mr-1"></i>${updated}</span>
                            </div>
                        </a>
                    `;
                }).join('');
            }

            if (loadingEl) loadingEl.classList.add('hidden');
        } catch (e) {
            console.error('获取仓库失败:', e);
            if (loadingEl) loadingEl.classList.add('hidden');
            if (errorEl) errorEl.classList.remove('hidden');
        }
    }

    // 加载 GitHub 贡献图（优先 SVG，失败回退 PNG）
    function loadContributionGraph() {
        const loadingEl = document.getElementById('contrib-loading');
        const errorEl = document.getElementById('contrib-error');
        const wrapEl = document.getElementById('contrib-graph-wrap');
        const imgEl = document.getElementById('contrib-graph');
        const sourceLink = document.getElementById('contrib-source');
        if (!imgEl || !loadingEl || !errorEl || !wrapEl) return;

        // 状态切换
        loadingEl.classList.remove('hidden');
        errorEl.classList.add('hidden');
        wrapEl.classList.add('hidden');

        // 强制非懒加载，避免被隐藏时浏览器不触发加载
        imgEl.removeAttribute('loading');
        try { imgEl.loading = 'eager'; } catch (_) {}
        imgEl.setAttribute('decoding', 'sync');

        const username = repoOwner;
        // 先尝试 PNG（更稳定），失败再回退到 SVG
        const pngUrl = `https://ghchart.rshah.org/2563eb/${encodeURIComponent(username)}?t=${Date.now()}`;
        const svgFallbackUrl = `https://github-readme-activity-graph.vercel.app/graph?username=${encodeURIComponent(username)}&bg_color=ffffff&color=334155&line=2563eb&point=2563eb&area=true&hide_border=true&t=${Date.now()}`;
        const profileUrl = `https://github.com/${encodeURIComponent(username)}`;

        if (sourceLink) sourceLink.href = profileUrl;

        // 清理旧事件与尝试标记
        imgEl.removeAttribute('data-fallback');
        let timeoutId = null;
        const clearTimer = () => { if (timeoutId) { clearTimeout(timeoutId); timeoutId = null; } };

        imgEl.onload = () => {
            clearTimer();
            loadingEl.classList.add('hidden');
            wrapEl.classList.remove('hidden');
        };
        imgEl.onerror = () => {
            clearTimer();
            // 首次失败，尝试回退源
            if (!imgEl.dataset.fallback) {
                imgEl.dataset.fallback = '1';
                imgEl.src = svgFallbackUrl;
                // 回退也增加超时保护
                timeoutId = setTimeout(() => {
                    loadingEl.classList.add('hidden');
                    errorEl.classList.remove('hidden');
                }, 10000);
            } else {
                // 回退也失败
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
            }
        };

        // 触发加载 + 超时兜底（10 秒）
        timeoutId = setTimeout(() => {
            // 若长时间无 onload/onerror，主动切换到回退
            if (!imgEl.dataset.fallback) {
                imgEl.dataset.fallback = '1';
                imgEl.src = svgFallbackUrl;
            }
        }, 10000);
        imgEl.src = pngUrl;
    }

    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
        // 加载GitHub基本信息
        loadGitHubInfo();

        // 加载更新内容
        loadUpdates();

        // 刷新按钮事件
        document.getElementById('refresh-updates').addEventListener('click', loadUpdates);

        // 加载我的 GitHub 仓库
        loadUserRepos();

        // GitHub 贡献图
        loadContributionGraph();
        const contribRetryBtn = document.getElementById('contrib-retry');
        if (contribRetryBtn) contribRetryBtn.addEventListener('click', loadContributionGraph);

        // 重新加载仓库按钮
        const reposRetryBtn = document.getElementById('repos-retry');
        if (reposRetryBtn) reposRetryBtn.addEventListener('click', loadUserRepos);

        // “我的 GitHub 项目”移动端折叠
        const reposToggle = document.getElementById('repos-toggle');
        const reposSection = document.getElementById('repos-section');
        if (reposToggle && reposSection) {
            reposToggle.addEventListener('click', () => {
                const expanded = reposToggle.getAttribute('aria-expanded') === 'true';
                if (expanded) {
                    reposSection.classList.add('hidden');
                    reposToggle.setAttribute('aria-expanded', 'false');
                    reposToggle.innerHTML = '展开 <i class="fa fa-chevron-down ml-1"></i>';
                } else {
                    reposSection.classList.remove('hidden');
                    reposToggle.setAttribute('aria-expanded', 'true');
                    reposToggle.innerHTML = '收起 <i class="fa fa-chevron-up ml-1"></i>';
                }
            });
        }
    });

    // 加载GitHub基本信息
    async function loadGitHubInfo() {
        try {
            // 获取仓库信息（星标、关注者等）
            const repoResponse = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}`);
            if (repoResponse.ok) {
                const data = await repoResponse.json();

                // 更新星标数
                const starsCount = data.stargazers_count;
                document.querySelectorAll('#github-stars, #github-stars-mobile, #repo-stars').forEach(el => {
                    el.innerHTML = `<i class="fa fa-star"></i> ${starsCount.toLocaleString()}`;
                    el.classList.remove('pulse');
                });

                // 更新页脚星标数
                document.getElementById('footer-stars').textContent = starsCount.toLocaleString();

                // 更新关注者数
                const watchersCount = data.subscribers_count;
                document.getElementById('repo-watchers').textContent = watchersCount.toLocaleString();

                // 更新最后更新时间
                const updatedAt = new Date(data.updated_at);
                document.getElementById('last-updated').textContent = updatedAt.toLocaleDateString('zh-CN');
            }

            // 获取最新版本
            const releasesResponse = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/releases/latest`);
            if (releasesResponse.ok) {
                const data = await releasesResponse.json();
                const version = data.tag_name;
                document.getElementById('latest-version').textContent = version;
                document.getElementById('version-info').textContent = version;
                document.getElementById('footer-version').textContent = version;

                // 移除加载动画
                document.querySelectorAll('#latest-version, #version-info, #footer-version').forEach(el => {
                    el.classList.remove('pulse');
                });
            } else {
                // 如果获取发布失败，尝试获取标签
                const tagsResponse = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/tags`);
                if (tagsResponse.ok) {
                    const tags = await tagsResponse.json();
                    if (tags.length > 0) {
                        const version = tags[0].name;
                        document.getElementById('latest-version').textContent = version;
                        document.getElementById('version-info').textContent = version;
                        document.getElementById('footer-version').textContent = version;

                        document.querySelectorAll('#latest-version, #version-info, #footer-version').forEach(el => {
                            el.classList.remove('pulse');
                        });
                    }
                }
            }

        } catch (error) {
            console.error('获取GitHub信息失败:', error);
            // 错误处理...
        }
    }

    // 移动端菜单切换
    document.getElementById('mobile-menu-button').addEventListener('click', function() {
        const mobileMenu = document.getElementById('mobile-menu');
        const icon = this.querySelector('i');

        // 切换菜单高度
        if (mobileMenu.classList.contains('h-0')) {
            mobileMenu.classList.remove('h-0');
            mobileMenu.classList.add('h-auto', 'py-2', 'border-t');
            icon.classList.replace('fa-bars', 'fa-times');
        } else {
            mobileMenu.classList.add('h-0');
            mobileMenu.classList.remove('h-auto', 'py-2', 'border-t');
            icon.classList.replace('fa-times', 'fa-bars');
        }
    });
</script>
</body>
</html>