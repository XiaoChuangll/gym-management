<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
  <meta charset="UTF-8">
  <title>通知管理 - 健身房管理系统</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Bootstrap CSS：一定要放在 Tailwind 之后 -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <!-- 添加Markdown支持 -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* Markdown样式 */
    .markdown-content {
      line-height: 1.6;
    }
    .markdown-content h1, .markdown-content h2, .markdown-content h3, 
    .markdown-content h4, .markdown-content h5, .markdown-content h6 {
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    .markdown-content h1 { font-size: 1.5rem; }
    .markdown-content h2 { font-size: 1.35rem; }
    .markdown-content h3 { font-size: 1.25rem; }
    .markdown-content h4 { font-size: 1.15rem; }
    .markdown-content h5 { font-size: 1.05rem; }
    .markdown-content h6 { font-size: 1rem; }
    .markdown-content p {
      margin-bottom: 1rem;
    }
    .markdown-content ul, .markdown-content ol {
      margin-left: 1.5rem;
      margin-bottom: 1rem;
    }
    .markdown-content ul { list-style-type: disc; }
    .markdown-content ol { list-style-type: decimal; }
    .markdown-content a {
      color: #165DFF;
      text-decoration: underline;
    }
    .markdown-content blockquote {
      border-left: 4px solid #e5e7eb;
      padding-left: 1rem;
      color: #6b7280;
      margin-bottom: 1rem;
    }
    .markdown-content pre {
      background-color: #f3f4f6;
      padding: 1rem;
      border-radius: 0.375rem;
      overflow-x: auto;
      margin-bottom: 1rem;
    }
    .markdown-content code {
      background-color: #f3f4f6;
      padding: 0.2rem 0.4rem;
      border-radius: 0.25rem;
      font-family: monospace;
    }
    .markdown-content table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }
    .markdown-content table th, .markdown-content table td {
      border: 1px solid #e5e7eb;
      padding: 0.5rem;
    }
    .markdown-content table th {
      background-color: #f9fafb;
    }
    .markdown-content hr {
      border: 0;
      border-top: 1px solid #e5e7eb;
      margin: 1rem 0;
    }
  </style>

  <!-- Tailwind配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36D399',
            accent: '#FFAB00',
            danger: '#F87171',
            warning: '#FBBF24',
            info: '#60A5FA',
            neutral: '#F8FAFC',
            'neutral-dark': '#334155'
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-hover {
        @apply transition-all duration-300 hover:shadow-lg hover:-translate-y-1;
      }
      .btn-primary {
        @apply bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300;
      }
      .btn-secondary {
        @apply bg-white border border-gray-300 hover:bg-gray-50 text-neutral-dark font-medium py-2 px-4 rounded-lg transition-all duration-300;
      }
      .btn-danger {
        @apply bg-danger hover:bg-danger/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300;
      }
      .btn-warning {
        @apply bg-warning hover:bg-warning/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300;
      }
      .btn-info {
        @apply bg-info hover:bg-info/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300;
      }
      .stat-card {
        @apply bg-white rounded-xl shadow-md p-6 transition-all duration-300 hover:shadow-lg;
      }
      .nav-link {
        @apply px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200;
      }
      .nav-link-active {
        @apply bg-primary/10 text-primary;
      }
      .sidebar-link {
        @apply flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-primary rounded-lg transition-colors duration-200;
      }
      .sidebar-link-active {
        @apply bg-primary/10 text-primary font-medium;
      }
      .notification-card {
        @apply bg-white rounded-xl shadow-md p-6 mb-4 transition-all duration-300 hover:shadow-lg border-l-4;
      }
      .notification-active {
        @apply border-primary;
      }
      .notification-archived {
        @apply border-gray-300;
      }
      .notification-high {
        @apply border-danger;
      }
      .notification-medium {
        @apply border-warning;
      }
      .notification-low {
        @apply border-info;
      }
      .btn-action {
        @apply w-8 h-8 rounded-full inline-flex items-center justify-center p-0 ml-2 transition-all duration-200 hover:scale-110;
      }
      .btn-archive {
        @apply bg-accent text-white;
      }
      .btn-activate {
        @apply bg-secondary text-white;
      }
      .btn-edit {
        @apply bg-primary text-white;
      }
      .btn-delete {
        @apply bg-danger text-white;
      }
      .priority-badge {
        @apply px-2 py-1 rounded-full text-xs font-medium;
      }
      .priority-high {
        @apply bg-danger/10 text-danger;
      }
      .priority-medium {
        @apply bg-warning/10 text-warning;
      }
      .priority-low {
        @apply bg-info/10 text-info;
      }
    }
  </style>
</head>
<body class="bg-gray-50 font-inter min-h-screen flex flex-col">
<!-- 顶部导航栏 -->
<header class="bg-white shadow-sm sticky top-0 z-50">
  <div class="container mx-auto px-4">
    <div class="flex justify-between items-center py-3">
      <div class="flex items-center space-x-2">
        <i class="fa fa-dumbbell text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-neutral-dark">健身房管理系统</h1>
      </div>

      <!-- 桌面导航 -->
      <nav class="hidden md:flex items-center space-x-1">
        <a th:href="@{/index}" class="nav-link">
          <i class="fa fa-home mr-1"></i> 首页
        </a>
        <a th:href="@{/members}" class="nav-link">
          <i class="fa fa-users mr-1"></i> 会员管理
        </a>
        <a th:href="@{/coaches}" class="nav-link">
          <i class="fa fa-user-circle mr-1"></i> 教练管理
        </a>
        <a th:href="@{/courses}" class="nav-link">
          <i class="fa fa-calendar mr-1"></i> 课程管理
        </a>
        <a th:href="@{/reservations}" class="nav-link">
          <i class="fa fa-book mr-1"></i> 预约管理
        </a>
        <a th:href="@{/notifications}" class="nav-link nav-link-active">
          <i class="fa fa-bullhorn mr-1"></i> 通知管理
        </a>
        <div class="relative group">
          <a href="#" class="nav-link flex items-center">
            <i class="fa fa-bar-chart mr-1"></i> 统计报表
            <i class="fa fa-chevron-down ml-1 text-xs"></i>
          </a>
          <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
            <a th:href="@{/reports/course-attendance}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">课程出勤</a>
            <a th:href="@{/reports/coach-workload}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">教练工作</a>
            <a th:href="@{/reports/member-reservations-selection}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">会员预约情况</a>
          </div>
        </div>
      </nav>

      <!-- 用户菜单 -->
      <div class="flex items-center space-x-3">
        <button class="p-2 rounded-full hover:bg-gray-100 transition-colors duration-200 relative">
          <i class="fa fa-bell-o text-gray-600"></i>
          <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
        </button>
        <div class="relative group">
          <button class="flex items-center space-x-2">
            <div class="w-8 h-8 rounded-full overflow-hidden flex items-center justify-center">
              <img id="headerUserAvatar" class="w-full h-full object-cover" src="/uploads/avatars/default.jpg" alt="头像">
            </div>
            <span id="headerDisplayName" class="hidden md:inline text-sm font-medium">用户</span>
          </button>
          <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
            <a th:if="${session.userRole != null && session.userRole == 'ADMIN'}" th:href="@{/notifications/manage}" class="block px-4 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100">
              <i class="fa fa-bullhorn mr-1"></i> 通知管理
            </a>
            <a th:href="@{/settings}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
              <i class="fa fa-cog mr-2"></i> 设置
            </a>
            <div class="border-t border-gray-100 my-1"></div>
            <a th:href="@{/logout}" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">
              <i class="fa fa-sign-out mr-2"></i> 退出登录
            </a>
          </div>
        </div>
        <!-- 移动端菜单按钮 -->
        <button class="md:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors duration-200" id="mobile-menu-button">
          <i class="fa fa-bars text-gray-600"></i>
        </button>
      </div>
    </div>

    <!-- 移动端导航菜单 -->
    <div class="md:hidden h-0 overflow-hidden transition-all duration-300" id="mobile-menu">
      <nav class="py-2 space-y-1">
        <a th:href="@{/index}" class="block px-4 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100">
          <i class="fa fa-home mr-1"></i> 首页
        </a>
        <a th:href="@{/members}" class="block px-4 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100">
          <i class="fa fa-users mr-1"></i> 会员管理
        </a>
        <a th:href="@{/coaches}" class="block px-4 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100">
          <i class="fa fa-user-circle mr-1"></i> 教练管理
        </a>
        <a th:href="@{/courses}" class="block px-4 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100">
          <i class="fa fa-calendar mr-1"></i> 课程管理
        </a>
        <a th:href="@{/reservations}" class="block px-4 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100">
          <i class="fa fa-book mr-1"></i> 预约管理
        </a>
        <a th:if="${session.userRole != null && session.userRole == 'ADMIN'}" th:href="@{/notifications/manage}" class="block px-4 py-2 rounded-md text-sm font-medium bg-primary/10 text-primary">
          <i class="fa fa-bullhorn mr-1"></i> 通知管理
        </a>
        <div class="px-4 py-2">
          <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider">统计报表</div>
          <a th:href="@{/reports/course-attendance}" class="block px-4 py-2 mt-1 rounded-md text-sm text-gray-600 hover:bg-gray-100">
            <i class="fa fa-line-chart mr-1"></i> 课程出勤
          </a>
          <a th:href="@{/reports/coach-workload}" class="block px-4 py-2 mt-1 rounded-md text-sm text-gray-600 hover:bg-gray-100">
            <i class="fa fa-bar-chart mr-1"></i> 教练工作
          </a>
          <a th:href="@{/reports/member-reservations-selection}" class="block px-4 py-2 mt-1 rounded-md text-sm text-gray-600 hover:bg-gray-100">
            <i class="fa fa-calendar-check-o mr-1"></i> 会员预约
          </a>
        </div>
      </nav>
    </div>
  </div>
</header>

<!-- 主内容区 -->
<main class="flex-grow container mx-auto px-4 py-6">
  <!-- 页面标题和面包屑 -->
  <div class="mb-6">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-neutral-dark mb-2 flex items-center">
          <i class="fa fa-bullhorn text-primary mr-3"></i>通知管理
        </h1>
        <nav class="flex" aria-label="面包屑">
          <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
              <a th:href="@{/index}" class="inline-flex items-center text-sm font-medium text-gray-500 hover:text-primary">
                <i class="fa fa-home mr-1"></i>
                首页
              </a>
            </li>
            <li>
              <div class="flex items-center">
                <i class="fa fa-chevron-right text-gray-400 text-xs mx-1"></i>
                <span class="text-sm font-medium text-primary">通知管理</span>
              </div>
            </li>
          </ol>
        </nav>
      </div>
      <button class="btn-primary flex items-center" data-bs-toggle="modal" data-bs-target="#createNotificationModal">
        <i class="fa fa-plus-circle mr-1"></i> 发布新通知
      </button>
    </div>
  </div>

  <!-- 搜索和筛选区域 -->
  <div class="bg-white rounded-xl shadow-md p-4 mb-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div class="flex-1">
        <div class="relative">
          <input type="text" id="searchInput" placeholder="搜索通知标题或内容..."
                 class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
          <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
        </div>
      </div>
      <div class="flex flex-col sm:flex-row gap-2">
        <select id="filterPriority" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
          <option value="">所有优先级</option>
          <option value="high">高优先级</option>
          <option value="medium">中优先级</option>
          <option value="low">低优先级</option>
        </select>
        <select id="filterTarget" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
          <option value="">所有目标</option>
          <option value="all">所有用户</option>
          <option value="members">仅会员</option>
          <option value="coaches">仅教练</option>
        </select>
        <button id="resetFilters" class="btn-secondary whitespace-nowrap">
          <i class="fa fa-refresh mr-1"></i>重置
        </button>
      </div>
    </div>
  </div>

  <!-- 批量操作区域 -->
  <div id="bulkActions" class="hidden bg-white rounded-xl shadow-md p-4 mb-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div class="flex items-center">
        <i class="fa fa-check-circle text-primary mr-2"></i>
        <span id="selectedCount">0</span> 项已选中
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="bulkArchive" class="btn-warning flex items-center">
          <i class="fa fa-archive mr-1"></i> 归档选中
        </button>
        <button id="bulkActivate" class="btn-secondary flex items-center">
          <i class="fa fa-bell mr-1"></i> 激活选中
        </button>
        <button id="bulkDelete" class="btn-danger flex items-center">
          <i class="fa fa-trash mr-1"></i> 删除选中
        </button>
      </div>
    </div>
  </div>

  <!-- 通知管理内容 -->
  <div class="bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 hover:shadow-lg">
    <div class="px-6 py-4 border-b border-gray-100">
      <ul class="flex border-b border-gray-200 nav nav-tabs" id="notificationTabs" role="tablist">
        <li class="mr-1 nav-item" role="presentation">
          <button class="nav-link active" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button" role="tab" aria-controls="active" aria-selected="true">
            <i class="fa fa-bell mr-1"></i> 活跃通知
            <span id="activeCount" class="ml-1 bg-primary text-white text-xs px-2 py-0.5 rounded-full">0</span>
          </button>
        </li>
        <li class="mr-1 nav-item" role="presentation">
          <button class="nav-link" id="archived-tab" data-bs-toggle="tab" data-bs-target="#archived" type="button" role="tab" aria-controls="archived" aria-selected="false">
            <i class="fa fa-archive mr-1"></i> 已归档通知
            <span id="archivedCount" class="ml-1 bg-gray-500 text-white text-xs px-2 py-0.5 rounded-full">0</span>
          </button>
        </li>
      </ul>
    </div>
    <div class="p-6">
      <div class="tab-content" id="notificationTabContent">
        <!-- 活跃通知 -->
        <div class="tab-pane fade show active" id="active" role="tabpanel" aria-labelledby="active-tab">
          <div id="no-active" class="hidden text-center py-8">
            <i class="fa fa-bell-slash text-4xl text-gray-300 mb-3"></i>
            <p class="text-gray-500">目前没有活跃的通知</p>
          </div>
          <div id="active-notifications" class="space-y-4">
            <div class="text-center py-8">
              <div class="spinner-border text-primary" role="status"></div>
              <p class="mt-2 text-gray-500">加载通知中...</p>
            </div>
          </div>
        </div>

        <!-- 已归档通知 -->
        <div class="tab-pane fade" id="archived" role="tabpanel" aria-labelledby="archived-tab">
          <div id="no-archived" class="hidden text-center py-8">
            <i class="fa fa-box-open text-4xl text-gray-300 mb-3"></i>
            <p class="text-gray-500">目前没有已归档的通知</p>
          </div>
          <div id="archived-notifications" class="space-y-4">
            <div class="text-center py-8">
              <div class="spinner-border text-primary" role="status"></div>
              <p class="mt-2 text-gray-500">加载通知中...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- 创建通知弹窗 -->
<div class="modal fade" id="createNotificationModal" tabindex="-1" aria-labelledby="createNotificationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createNotificationModalLabel">
          <i class="fa fa-plus-circle me-2"></i>发布新通知
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="createNotificationForm">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label for="title" class="block text-sm font-medium text-gray-700 mb-1">标题*</label>
              <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                     id="title" name="title" placeholder="输入通知标题" required>
            </div>
            <div>
              <label for="priority" class="block text-sm font-medium text-gray-700 mb-1">优先级*</label>
              <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                      id="priority" name="priority" required>
                <option value="high">高优先级</option>
                <option value="medium" selected>中优先级</option>
                <option value="low">低优先级</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label for="target" class="block text-sm font-medium text-gray-700 mb-1">目标受众*</label>
              <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                      id="target" name="target" required>
                <option value="all" selected>所有用户</option>
                <option value="members">仅会员</option>
                <option value="coaches">仅教练</option>
              </select>
            </div>
            <div>
              <label for="expiryDate" class="block text-sm font-medium text-gray-700 mb-1">有效期至</label>
              <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                     id="expiryDate" name="expiryDate" placeholder="选择日期" data-input>
            </div>
          </div>
          <div class="mb-4">
            <label for="content" class="block text-sm font-medium text-gray-700 mb-1">内容*</label>
            <textarea class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                      id="content" name="content" rows="6" placeholder="输入通知详细内容" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn-primary" id="submitNotification">
          <i class="fa fa-paper-plane mr-1"></i>发布通知
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 编辑通知弹窗 -->
<div class="modal fade" id="editNotificationModal" tabindex="-1" aria-labelledby="editNotificationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editNotificationModalLabel">
          <i class="fa fa-edit me-2"></i>编辑通知
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editNotificationForm">
          <input type="hidden" id="edit-id">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label for="edit-title" class="block text-sm font-medium text-gray-700 mb-1">标题*</label>
              <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                     id="edit-title" name="title" required>
            </div>
            <div>
              <label for="edit-priority" class="block text-sm font-medium text-gray-700 mb-1">优先级*</label>
              <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                      id="edit-priority" name="priority" required>
                <option value="high">高优先级</option>
                <option value="medium">中优先级</option>
                <option value="low">低优先级</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label for="edit-target" class="block text-sm font-medium text-gray-700 mb-1">目标受众*</label>
              <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                      id="edit-target" name="target" required>
                <option value="all">所有用户</option>
                <option value="members">仅会员</option>
                <option value="coaches">仅教练</option>
              </select>
            </div>
            <div>
              <label for="edit-expiryDate" class="block text-sm font-medium text-gray-700 mb-1">有效期至</label>
              <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                     id="edit-expiryDate" name="expiryDate" data-input>
            </div>
          </div>
          <div class="mb-4">
            <label for="edit-content" class="block text-sm font-medium text-gray-700 mb-1">内容*</label>
            <textarea class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                      id="edit-content" name="content" rows="6" required></textarea>
          </div>
          <div class="mb-4">
            <label for="edit-status" class="block text-sm font-medium text-gray-700 mb-1">状态</label>
            <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    id="edit-status" name="status">
              <option value="active">活跃</option>
              <option value="archived">归档</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn-primary" id="updateNotification">
          <i class="fa fa-save mr-1"></i>保存更改
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 预览通知弹窗 -->
<div class="modal fade" id="previewNotificationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fa fa-eye me-2"></i>通知预览
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="notification-card notification-active mb-0">
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="text-lg font-semibold text-primary flex items-center" id="preview-title">
                <i class="fa fa-bell mr-2"></i>
                通知标题
              </h3>
              <div class="flex items-center space-x-2 mt-2 mb-3">
                <span class="priority-badge priority-high" id="preview-priority">高优先级</span>
                <span class="text-sm text-gray-500" id="preview-target">
                                    <i class="fa fa-users mr-1"></i>目标: 所有用户
                                </span>
                <span class="text-sm text-gray-500" id="preview-expiry">
                                    <i class="fa fa-clock mr-1"></i>有效期: 2023-12-31
                                </span>
              </div>
              <p class="text-gray-600" id="preview-content">通知内容将在这里显示...</p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-primary" data-bs-dismiss="modal">关闭预览</button>
      </div>
    </div>
  </div>
</div>

<!-- 确认对话框 -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalTitle">确认操作</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="confirmModalMessage">确定要执行此操作吗？</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn-danger" id="confirmButton">确认</button>
      </div>
    </div>
  </div>
</div>

<!-- 页脚 -->
<footer class="bg-white border-t border-gray-200 py-6 mt-auto">
  <div class="container mx-auto px-4">
    <div class="flex flex-col md:flex-row justify-between items-center">
      <div class="mb-4 md:mb-0">
        <p class="text-sm text-gray-500">© 2025 健身房管理系统 | 版权所有</p>
      </div>
      <div class="flex space-x-4">
        <a href="#" class="text-gray-400 hover:text-primary transition-colors duration-200">
          <i class="fa fa-weixin text-xl"></i>
        </a>
        <a href="#" class="text-gray-400 hover:text-primary transition-colors duration-200">
          <i class="fa fa-weibo text-xl"></i>
        </a>
        <a href="#" class="text-gray-400 hover:text-primary transition-colors duration-200">
          <i class="fa fa-instagram text-xl"></i>
        </a>
        <a href="#" class="text-gray-400 hover:text-primary transition-colors duration-200">
          <i class="fa fa-twitter text-xl"></i>
        </a>
      </div>
    </div>
  </div>
</footer>

<!-- JavaScript依赖 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>

<script>
  // 配置marked.js
  marked.setOptions({
    breaks: true,        // 允许换行符转换为<br>
    gfm: true,           // 使用GitHub风格Markdown
    headerIds: true,     // 为标题添加id
    mangle: false,       // 不转义HTML标签中的内容
    sanitize: false,     // 不过滤HTML标签
    smartLists: true,    // 使用更智能的列表行为
    smartypants: true,   // 使用更智能的标点符号
    xhtml: false         // 不使用xhtml格式的标签
  });

  // 定义管理员标志
  const isAdmin = true; // 由于这个页面只有管理员能访问，所以直接设置为true
  let selectedNotifications = [];
  let notificationsData = []; // 保存所有通知数据

  $(document).ready(function() {
    console.log("页面加载完成，初始化...");

    // 初始化日期选择器
    flatpickr("#expiryDate", {
      dateFormat: "Y-m-d",
      locale: "zh"
    });
    
    flatpickr("#edit-expiryDate", {
      dateFormat: "Y-m-d",
      locale: "zh"
    });
    
    // 手动初始化Bootstrap标签页
    const triggerTabList = document.querySelectorAll('#notificationTabs button');
    triggerTabList.forEach(function(triggerEl) {
      try {
        const tabTrigger = new bootstrap.Tab(triggerEl);
        
        triggerEl.addEventListener('click', function(event) {
          event.preventDefault();
          console.log("点击标签页:", triggerEl.id);
          
          // 直接处理标签页内容显示
          if(triggerEl.id === 'active-tab') {
            console.log("手动显示活跃通知");
            $('#active').addClass('show active');
            $('#archived').removeClass('show active');
            displayNotificationsByStatus('active');
          } else if(triggerEl.id === 'archived-tab') {
            console.log("手动显示已归档通知");
            $('#archived').addClass('show active');
            $('#active').removeClass('show active');
            displayNotificationsByStatus('archived');
          }
          
          // 更新标签页状态
          document.querySelectorAll('#notificationTabs button').forEach(function(btn) {
            btn.classList.remove('active');
            btn.setAttribute('aria-selected', 'false');
          });
          triggerEl.classList.add('active');
          triggerEl.setAttribute('aria-selected', 'true');
        });
      } catch(e) {
        console.error("初始化标签页出错:", e);
      }
    });
    
    // 初始化标签页切换事件
    $('#notificationTabs button[data-bs-toggle="tab"]').on('shown.bs.tab', function(e) {
      const activeTabId = $(e.target).attr('id');
      console.log("标签已切换:", activeTabId);
      
      // 根据当前标签页显示相应的通知
      if (activeTabId === 'active-tab') {
        displayNotificationsByStatus('active');
      } else if (activeTabId === 'archived-tab') {
        console.log("显示已归档通知");
        displayNotificationsByStatus('archived');
      }
    });

    // 加载通知
    loadNotifications();

    // 绑定事件
    bindEvents();

    // 初始化提示工具
    initializeTooltips();
    
    // 确保已归档标签页可以正常显示
    console.log("设置已归档标签页测试");
    setTimeout(function() {
      // 测试已归档标签页是否可以正常显示
      console.log("测试已归档标签页显示");
      
      // 直接执行归档标签页显示逻辑
      $('#notificationTabs button').removeClass('active').attr('aria-selected', 'false');
      $('#archived-tab').addClass('active').attr('aria-selected', 'true');
      
      // 手动切换内容区域
      $('.tab-pane').removeClass('show active');
      $('#archived').addClass('show active');
      
      // 确保已归档通知显示
      const archivedNotifications = notificationsData.filter(n => n.status === 'archived');
      console.log("已归档通知数量:", archivedNotifications.length);
      
      if(archivedNotifications.length === 0) {
        $('#no-archived').removeClass('hidden').show();
        $('#archived-notifications').html('');
      } else {
        $('#no-archived').hide();
        let html = '';
        archivedNotifications.forEach(notification => {
          html += renderNotificationItem(notification, false);
          console.log("渲染已归档通知:", notification.id, notification.title);
        });
        $('#archived-notifications').html(html);
      }
      
      // 添加事件处理
      attachEventHandlers();
    }, 1000);
  });

  // 加载通知数据
  function loadNotifications() {
    console.log("开始加载通知数据...");
    
    // 显示加载中状态
    $('#active-notifications').html('<div class="text-center py-8"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-gray-500">加载通知中...</p></div>');
    $('#archived-notifications').html('<div class="text-center py-8"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-gray-500">加载通知中...</p></div>');
    
    // 使用测试数据（开发模式）
    const useTestData = false; // 设置为true使用测试数据，false则尝试从API获取
    
    // 如果使用测试数据，则跳过API调用
    if (useTestData) {
      console.log("使用测试数据...");
      const testData = [
        {
          id: 1,
          title: "测试通知1",
          content: "这是活跃通知内容",
          status: "active",
          priority: "high",
          target: "all",
          createdAt: new Date().toISOString(),
          createdByUsername: "系统"
        },
        {
          id: 2,
          title: "测试通知2 - 已归档",
          content: "这是已归档通知内容",
          status: "archived",
          priority: "medium",
          target: "members",
          createdAt: new Date().toISOString(),
          createdByUsername: "系统"
        },
        {
          id: 3,
          title: "测试通知3 - 已归档",
          content: "这是另一条已归档通知内容",
          status: "archived",
          priority: "low",
          target: "coaches",
          createdAt: new Date().toISOString(),
          createdByUsername: "系统"
        }
      ];
      
      // 使用测试数据
      notificationsData = testData;
      
      // 更新计数
      updateCounts(testData);
      
      // 默认显示活跃通知
      displayNotificationsByStatus('active');
      
      // 初始化折叠图标
      setTimeout(initializeCollapseIcons, 100);
      
      return;
    }
    
    // 发送AJAX请求获取所有通知
    $.ajax({
      url: '/api/notifications',
      type: 'GET',
      success: function(notifications) {
        console.log("获取到通知数据:", notifications);
        
        // 保存通知数据
        notificationsData = notifications;
        
        // 获取当前活动的标签页
        const activeTabId = $('#notificationTabs button.active').attr('id');
        console.log("当前活动标签:", activeTabId);
        
        // 预处理通知数据，确保状态字段存在
        notifications.forEach(notification => {
          if (!notification.status) {
            notification.status = 'active'; // 默认为活跃状态
          }
        });
        
        // 分别准备活跃和已归档通知
        const activeNotifications = notifications.filter(n => n.status === 'active');
        const archivedNotifications = notifications.filter(n => n.status === 'archived');
        
        console.log("活跃通知数量:", activeNotifications.length);
        console.log("已归档通知数量:", archivedNotifications.length);
        
        // 根据当前标签页显示相应的通知
        if (activeTabId === 'active-tab') {
          displayNotificationsByStatus('active');
        } else if (activeTabId === 'archived-tab') {
          displayNotificationsByStatus('archived');
        } else {
          // 默认显示活跃通知
          displayNotificationsByStatus('active');
        }
        
        // 更新计数
        updateCounts(notifications);

        // 初始化折叠图标
        setTimeout(initializeCollapseIcons, 100);
      },
      error: function(xhr, status, error) {
        console.error('加载通知失败:', {xhr: xhr, status: status, error: error});
        showAlert('加载通知失败: ' + (xhr.responseText || '服务器错误'), 'danger');

        // 临时测试数据，以防API不可用
        console.log("使用测试数据...");
        const testData = [
          {
            id: 1,
            title: "测试通知1",
            content: "这是活跃通知内容",
            status: "active",
            priority: "high",
            target: "all",
            createdAt: new Date().toISOString(),
            createdByUsername: "系统"
          },
          {
            id: 2,
            title: "测试通知2 - 已归档",
            content: "这是已归档通知内容",
            status: "archived",
            priority: "medium",
            target: "members",
            createdAt: new Date().toISOString(),
            createdByUsername: "系统"
          },
          {
            id: 3,
            title: "测试通知3 - 已归档",
            content: "这是另一条已归档通知内容",
            status: "archived",
            priority: "low",
            target: "coaches",
            createdAt: new Date().toISOString(),
            createdByUsername: "系统"
          }
        ];

        notificationsData = testData;
        displayFilteredNotifications();
        updateCounts(testData);
        
        // 初始化折叠图标
        setTimeout(initializeCollapseIcons, 500);
      }
    });
  }

  // 初始化折叠图标
  function initializeCollapseIcons() {
    // 获取所有通知内容元素
    const notificationContents = document.querySelectorAll('[id^="notification-content-"]');
    
    // 为每个通知内容设置初始状态
    notificationContents.forEach(content => {
      const notificationId = content.id.replace('notification-content-', '');
      const iconElement = document.getElementById(`toggle-icon-${notificationId}`);
      const textElement = document.getElementById(`toggle-text-${notificationId}`);
      
      // 默认是展开状态
      content.style.display = 'block';
      
      if (iconElement) {
        // 默认是展开状态，所以图标应该是向上的
        iconElement.classList.remove('fa-chevron-down');
        iconElement.classList.add('fa-chevron-up');
      }
      
      if (textElement) {
        textElement.textContent = '收起内容';
      }
    });
  }

  // 更新通知计数
  function updateCounts(notifications) {
    const activeCount = notifications.filter(n => n.status === 'active').length;
    const archivedCount = notifications.filter(n => n.status === 'archived').length;

    console.log("更新计数 - 活跃:", activeCount, "已归档:", archivedCount);

    $('#activeCount').text(activeCount);
    $('#archivedCount').text(archivedCount);
  }

  // 根据当前标签页显示通知
  function displayFilteredNotifications() {
    console.log("显示筛选后的通知...");
    // 确定当前活动的标签页
    const activeTab = $('#notificationTabs button.active').attr('id');
    console.log("当前活动标签:", activeTab);

    if(activeTab === 'active-tab') {
      displayNotificationsByStatus('active');
    } else {
      // 如果不是活跃标签，则显示已归档通知（默认情况）
      displayNotificationsByStatus('archived');
    }
    
    // 延迟初始化折叠图标，确保DOM已更新
    setTimeout(initializeCollapseIcons, 100);
  }

  // 按状态显示通知
  function displayNotificationsByStatus(status) {
    console.log("按状态显示通知:", status);
    const filteredNotifications = notificationsData.filter(n => n.status === status);
    console.log("筛选出", filteredNotifications.length, "条", status, "通知");

    if(status === 'active') {
      if(filteredNotifications.length === 0) {
        $('#no-active').removeClass('hidden').show();
        $('#active-notifications').html('');
      } else {
        $('#no-active').hide();
        let html = '';
        filteredNotifications.forEach(notification => {
          html += renderNotificationItem(notification, true);
        });
        $('#active-notifications').html(html);
      }
    } else if(status === 'archived') {
      console.log("处理已归档通知显示");
      if(filteredNotifications.length === 0) {
        $('#no-archived').removeClass('hidden').show();
        $('#archived-notifications').html('');
        console.log("没有已归档通知，显示空状态");
      } else {
        $('#no-archived').hide();
        let html = '';
        filteredNotifications.forEach(notification => {
          html += renderNotificationItem(notification, false);
          console.log("添加已归档通知:", notification.id, notification.title);
        });
        $('#archived-notifications').html(html);
        console.log("已添加已归档通知到DOM");
      }
    }

    // 添加事件处理
    attachEventHandlers();
    
    console.log(`${status}通知显示完成`);
  }

  // 附加事件处理器到按钮
  function attachEventHandlers() {
    console.log("附加事件处理器...");

    // 先移除所有事件处理器
    $('.btn-archive').off('click');
    $('.btn-activate').off('click');
    $('.btn-edit').off('click');
    $('.btn-delete').off('click');
    $('.notification-checkbox').off('change');

    // 归档按钮
    $('.btn-archive').on('click', function() {
      const id = Number($(this).data('id'));
      console.log("点击归档按钮, ID类型:", typeof id, "值:", id);
      if (isNaN(id) || id <= 0) {
        console.error("无效的通知ID:", $(this).data('id'));
        showAlert('无效的通知ID', 'warning');
        return;
      }
      updateNotificationStatus(id, 'archived');
    });

    // 激活按钮
    $('.btn-activate').on('click', function() {
      const id = Number($(this).data('id'));
      console.log("点击激活按钮, ID类型:", typeof id, "值:", id);
      if (isNaN(id) || id <= 0) {
        console.error("无效的通知ID:", $(this).data('id'));
        showAlert('无效的通知ID', 'warning');
        return;
      }
      updateNotificationStatus(id, 'active');
    });

    // 编辑按钮
    $('.btn-edit').on('click', function() {
      const id = Number($(this).data('id'));
      console.log("点击编辑按钮, ID类型:", typeof id, "值:", id);
      const notification = notificationsData.find(n => n.id === id);

      if(notification) {
        $('#edit-id').val(notification.id);
        $('#edit-title').val(notification.title);
        $('#edit-content').val(notification.content);
        $('#edit-status').val(notification.status);
        $('#edit-priority').val(notification.priority || 'medium');
        $('#edit-target').val(notification.target || 'all');
        $('#edit-expiryDate').val(notification.expiryDate || '');
        $('#editNotificationModal').modal('show');
      } else {
        console.error("找不到ID为", id, "的通知");
        showAlert('找不到相应通知', 'warning');
      }
    });

    // 删除按钮
    $('.btn-delete').on('click', function() {
      const id = Number($(this).data('id'));
      console.log("点击删除按钮, ID类型:", typeof id, "值:", id);
      showConfirmDialog('确定要删除这条通知吗？', '删除后将无法恢复', function() {
        deleteNotification(id);
      });
    });

    // 选择框
    $('.notification-checkbox').on('change', function() {
      const id = Number($(this).data('id'));
      const isChecked = $(this).is(':checked');

      if (isChecked) {
        if (!selectedNotifications.includes(id)) {
          selectedNotifications.push(id);
        }
      } else {
        selectedNotifications = selectedNotifications.filter(item => item !== id);
      }

      updateBulkActions();
    });
  }

  // 显示通知项
  function renderNotificationItem(notification, isActive) {
    // 格式化日期
    const date = new Date(notification.createdAt);
    const formattedDate = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

    let actionButtons = '';
    if (isAdmin) {
      if (isActive) {
        actionButtons = `
                    <button class="btn-action btn-archive" data-id="${notification.id}" title="归档" onclick="console.log('归档按钮点击, ID:', ${notification.id});">
                        <i class="fa fa-archive"></i>
                    </button>
                    <button class="btn-action btn-edit" data-id="${notification.id}" title="编辑">
                        <i class="fa fa-edit"></i>
                    </button>
                    <button class="btn-action btn-delete" data-id="${notification.id}" title="删除">
                        <i class="fa fa-trash"></i>
                    </button>
                `;
      } else {
        actionButtons = `
                    <button class="btn-action btn-activate" data-id="${notification.id}" title="激活" onclick="console.log('激活按钮点击, ID:', ${notification.id});">
                        <i class="fa fa-check"></i>
                    </button>
                    <button class="btn-action btn-edit" data-id="${notification.id}" title="编辑">
                        <i class="fa fa-edit"></i>
                    </button>
                    <button class="btn-action btn-delete" data-id="${notification.id}" title="删除">
                        <i class="fa fa-trash"></i>
                    </button>
                `;
      }
    }

    // 使用默认值处理可能不存在的字段
    const priority = notification.priority || 'medium';
    const target = notification.target || 'all';

    const priorityClass = getPriorityClass(priority);
    const priorityText = getPriorityText(priority);
    const targetText = getTargetText(target);
    const notificationClass = isActive ? 'notification-active' : 'notification-archived';

    return `
            <div class="notification-card ${notificationClass} ${priorityClass}">
                <div class="flex items-start">
                    <div class="mr-3 mt-1">
                        <input type="checkbox" class="notification-checkbox rounded border-gray-300 text-primary focus:ring-primary" data-id="${notification.id}">
                    </div>
                    <div class="flex-1">
                        <!-- 标题栏和操作按钮放在同一栏 -->
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-primary flex items-center flex-wrap cursor-pointer" onclick="toggleNotificationContent('notification-content-${notification.id}')">
                                <i class="fa ${isActive ? 'fa-bell' : 'fa-archive'} mr-2"></i>
                                ${notification.title}
                                <i class="fa fa-chevron-up ml-2 text-xs text-gray-500" id="toggle-icon-${notification.id}"></i>
                                <span class="text-xs text-gray-400 ml-2" id="toggle-text-${notification.id}">收起内容</span>
                            </h3>
                            <div class="flex">
                                ${actionButtons}
                            </div>
                        </div>
                        
                        <!-- 优先级和目标信息 -->
                        <div class="flex flex-wrap items-center gap-2 mb-3">
                            <span class="priority-badge ${priorityClass}">${priorityText}</span>
                            <span class="text-sm text-gray-500 flex items-center">
                                <i class="fa fa-users mr-1"></i>目标: ${targetText}
                            </span>
                        </div>
                        
                        <!-- 通知内容 - 可折叠 -->
                        <div id="notification-content-${notification.id}" class="mb-3">
                            <div class="text-gray-600 markdown-content">${typeof marked !== 'undefined' && typeof marked.parse === 'function' ? marked.parse(notification.content || '') : notification.content || ''}</div>
                        </div>
                        
                        <!-- 底部信息 - 移动端优化 -->
                        <div class="text-sm text-gray-500">
                            <div class="flex flex-wrap items-center gap-2 sm:gap-4">
                                <span class="flex items-center">
                                    <i class="fa fa-user-circle mr-1"></i>发布者: ${notification.createdByUsername || '系统'}
                                </span>
                                <span class="flex items-center">
                                    <i class="fa fa-clock mr-1"></i>发布时间: ${formattedDate}
                                </span>
                                ${notification.expiryDate ? `
                                <span class="flex items-center">
                                    <i class="fa fa-calendar mr-1"></i>有效期至: ${notification.expiryDate}
                                </span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
  }

  // 获取优先级样式类
  function getPriorityClass(priority) {
    switch(priority) {
      case 'high': return 'priority-high';
      case 'medium': return 'priority-medium';
      case 'low': return 'priority-low';
      default: return 'priority-medium';
    }
  }

  // 获取优先级文本
  function getPriorityText(priority) {
    switch(priority) {
      case 'high': return '高优先级';
      case 'medium': return '中优先级';
      case 'low': return '低优先级';
      default: return '中优先级';
    }
  }

  // 获取目标文本
  function getTargetText(target) {
    switch(target) {
      case 'all': return '所有用户';
      case 'members': return '仅会员';
      case 'coaches': return '仅教练';
      default: return '所有用户';
    }
  }

  // 切换通知内容显示/隐藏
  function toggleNotificationContent(contentId) {
    const contentElement = document.getElementById(contentId);
    const notificationId = contentId.replace('notification-content-', '');
    const iconElement = document.getElementById(`toggle-icon-${notificationId}`);
    const textElement = document.getElementById(`toggle-text-${notificationId}`);
    
    if (contentElement) {
      if (contentElement.style.display === 'none') {
        // 显示内容
        contentElement.style.display = 'block';
        if (iconElement) {
          iconElement.classList.remove('fa-chevron-down');
          iconElement.classList.add('fa-chevron-up');
        }
        if (textElement) {
          textElement.textContent = '收起内容';
        }
      } else {
        // 隐藏内容
        contentElement.style.display = 'none';
        if (iconElement) {
          iconElement.classList.remove('fa-chevron-up');
          iconElement.classList.add('fa-chevron-down');
        }
        if (textElement) {
          textElement.textContent = '展开内容';
        }
      }
    }
  }

  // 更新通知状态
  function updateNotificationStatus(id, status) {
    console.log("开始更新通知状态, ID:", id, "新状态:", status);

    // 查找本地通知
    const localNotification = notificationsData.find(n => n.id === id);
    if (localNotification) {
      // 准备更新数据
      const updateData = {
        title: localNotification.title,
        content: localNotification.content,
        priority: localNotification.priority || 'medium',
        target: localNotification.target || 'all',
        status: status,
        expiryDate: localNotification.expiryDate
      };

      console.log("发送更新请求，数据:", JSON.stringify(updateData));

      // 发送AJAX请求到服务器保存更改
      $.ajax({
        url: `/api/notifications/${id}`,
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(updateData),
        success: function(response) {
          console.log("更新成功，服务器响应:", response);
          // 更新本地状态
          localNotification.status = status;
          // 刷新界面
          displayFilteredNotifications();
          updateCounts(notificationsData);
          // 显示成功消息
          showAlert(`通知已${status === 'active' ? '激活' : '归档'}`, 'success');
        },
        error: function(xhr, status, error) {
          console.error('更新状态失败:', {
            status: xhr.status,
            statusText: xhr.statusText,
            responseText: xhr.responseText,
            error: error
          });
          showAlert('更新状态失败: ' + (xhr.responseText || '服务器错误'), 'danger');
        },
        complete: function() {
          console.log("AJAX请求完成");
        }
      });
    } else {
      console.error("找不到ID为", id, "的通知");
      showAlert('未找到相应通知', 'warning');
    }
  }

  // 批量更新状态
  function bulkUpdateStatus(ids, status) {
    // 由于没有批量API，我们逐个更新
    let successCount = 0;
    let errorCount = 0;

    // 使用Promise.all处理多个请求
    const promises = ids.map(id => {
      return new Promise((resolve, reject) => {
        // 先从服务器获取最新的通知详情
        $.ajax({
          url: `/api/notifications/${id}`,
          type: 'GET',
          success: function(notification) {
            // 只更新状态字段
            notification.status = status;

            // 发送更新请求
            $.ajax({
              url: `/api/notifications/${id}`,
              type: 'PUT',
              contentType: 'application/json',
              data: JSON.stringify(notification),
              success: function() {
                successCount++;
                resolve();
              },
              error: function(xhr) {
                console.error('批量更新失败:', xhr);
                errorCount++;
                reject(xhr);
              }
            });
          },
          error: function(xhr) {
            // 如果无法获取服务器数据，尝试使用本地数据
            const notification = notificationsData.find(n => n.id == id);
            if (notification) {
              const updateData = {
                title: notification.title,
                content: notification.content,
                priority: notification.priority || 'medium',
                target: notification.target || 'all',
                status: status,
                expiryDate: notification.expiryDate
              };

              $.ajax({
                url: `/api/notifications/${id}`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(updateData),
                success: function() {
                  successCount++;
                  resolve();
                },
                error: function(xhr) {
                  errorCount++;
                  reject(xhr);
                }
              });
            } else {
              errorCount++;
              reject(new Error("找不到通知"));
            }
          }
        });
      });
    });

    Promise.allSettled(promises).then(() => {
      selectedNotifications = [];
      updateBulkActions();
      loadNotifications();
      if (errorCount === 0) {
        showAlert(`已成功${status === 'active' ? '激活' : '归档'} ${successCount} 条通知`, 'success');
      } else {
        showAlert(`成功${status === 'active' ? '激活' : '归档'} ${successCount} 条通知，失败 ${errorCount} 条`, 'warning');
      }
    });
  }

  // 删除通知
  function deleteNotification(id) {
    $.ajax({
      url: `/api/notifications/${id}`,
      type: 'DELETE',
      success: function() {
        loadNotifications();
        showAlert('通知已删除', 'success');
      },
      error: function(xhr) {
        showAlert('删除失败: ' + xhr.responseText, 'danger');
      }
    });
  }

  // 批量删除
  function bulkDelete(ids) {
    // 由于没有批量API，我们逐个删除
    let successCount = 0;
    let errorCount = 0;

    // 使用Promise.all处理多个请求
    const promises = ids.map(id => {
      return new Promise((resolve, reject) => {
        $.ajax({
          url: `/api/notifications/${id}`,
          type: 'DELETE',
          success: function() {
            successCount++;
            resolve();
          },
          error: function(xhr) {
            errorCount++;
            reject(xhr);
          }
        });
      });
    });

    Promise.allSettled(promises).then(() => {
      selectedNotifications = [];
      updateBulkActions();
      loadNotifications();
      if (errorCount === 0) {
        showAlert(`已成功删除 ${successCount} 条通知`, 'success');
      } else {
        showAlert(`成功删除 ${successCount} 条通知，失败 ${errorCount} 条`, 'warning');
      }
    });
  }

  // 更新批量操作区域
  function updateBulkActions() {
    const count = selectedNotifications.length;
    $('#selectedCount').text(count);

    if (count > 0) {
      $('#bulkActions').removeClass('hidden');
      $('#selectAll').prop('checked', $('.notification-checkbox').length === count);
    } else {
      $('#bulkActions').addClass('hidden');
      $('#selectAll').prop('checked', false);
    }
  }

  // 筛选通知
  function filterNotifications(searchTerm = '') {
    const priorityFilter = $('#filterPriority').val();
    const targetFilter = $('#filterTarget').val();

    $('.notification-card').each(function() {
      const card = $(this);
      const title = card.find('h3').text().toLowerCase();
      const content = card.find('p').text().toLowerCase();
      const priority = card.find('.priority-badge').text().toLowerCase();
      const target = card.find('span:contains("目标:")').text().toLowerCase();

      const matchesSearch = searchTerm === '' ||
              title.includes(searchTerm) ||
              content.includes(searchTerm);

      const matchesPriority = priorityFilter === '' ||
              (priorityFilter === 'high' && priority.includes('高')) ||
              (priorityFilter === 'medium' && priority.includes('中')) ||
              (priorityFilter === 'low' && priority.includes('低'));

      const matchesTarget = targetFilter === '' ||
              (targetFilter === 'all' && target.includes('所有')) ||
              (targetFilter === 'members' && target.includes('会员')) ||
              (targetFilter === 'coaches' && target.includes('教练'));

      if (matchesSearch && matchesPriority && matchesTarget) {
        card.show();
      } else {
        card.hide();
      }
    });

    // 更新空状态显示
    updateEmptyState();
  }

  // 更新空状态显示
  function updateEmptyState() {
    const activeTab = $('.tab-pane.active');
    const visibleCards = activeTab.find('.notification-card:visible').length;

    if (visibleCards === 0) {
      if (activeTab.attr('id') === 'active') {
        $('#no-active').removeClass('hidden').show();
      } else if (activeTab.attr('id') === 'archived') {
        $('#no-archived').removeClass('hidden').show();
      }
    } else {
      if (activeTab.attr('id') === 'active') {
        $('#no-active').hide();
      } else if (activeTab.attr('id') === 'archived') {
        $('#no-archived').hide();
      }
    }
  }

  // 显示提示框
  function showAlert(message, type) {
    const alert = document.createElement('div');
    alert.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg ${
            type === 'danger' ? 'bg-red-100 text-red-700' :
                    type === 'warning' ? 'bg-yellow-100 text-yellow-700' :
                            'bg-green-100 text-green-700'
    }`;
    alert.innerHTML = `
            <div class="flex items-center">
                <i class="fa ${
            type === 'danger' ? 'fa-exclamation-circle' :
                    type === 'warning' ? 'fa-exclamation-triangle' :
                            'fa-check-circle'
    } mr-2"></i>
                <span>${message}</span>
            </div>
        `;
    document.body.appendChild(alert);

    setTimeout(() => {
      alert.remove();
    }, 3000);
  }

  // 显示确认对话框
  function showConfirmDialog(title, message, confirmCallback) {
    $('#confirmModalTitle').text(title);
    $('#confirmModalMessage').text(message);

    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    confirmModal.show();

    $('#confirmButton').off('click').on('click', function() {
      confirmCallback();
      confirmModal.hide();
    });
  }

  // MD5函数，用于生成Gravatar头像
  function md5(string) {
    if(!string) return '00000000000000000000000000000000';

    // 简化版，仅用于生成Gravatar URL
    // 返回一个固定的哈希值，仅用于演示
    var hash = '';
    for (var i = 0; i < 32; i++) {
      hash += (Math.floor(Math.random() * 16)).toString(16);
    }
    return hash;
  }

  // 绑定事件
  function bindEvents() {
    console.log("绑定事件...");

    // 创建通知表单提交
    $('#submitNotification').on('click', function() {
      console.log("提交新通知");
      submitNotification();
    });

    // 更新通知表单提交
    $('#updateNotification').on('click', function() {
      console.log("更新通知");
      updateNotification();
    });

    // 重置筛选器
    $('#resetFilters').on('click', function() {
      console.log("重置筛选器");
      $('#searchInput').val('');
      $('#filterPriority').val('');
      $('#filterTarget').val('');
      displayFilteredNotifications();
    });

    // 搜索和筛选
    $('#searchInput, #filterPriority, #filterTarget').on('input change', function() {
      console.log("应用筛选器");
      displayFilteredNotifications();
    });

    // 批量归档
    $('#bulkArchive').on('click', function() {
      console.log("批量归档");
      bulkChangeStatus('archived');
    });

    // 批量激活
    $('#bulkActivate').on('click', function() {
      console.log("批量激活");
      bulkChangeStatus('active');
    });

    // 批量删除
    $('#bulkDelete').on('click', function() {
      console.log("批量删除");
      bulkDelete();
    });

    // 全选/取消全选
    $('#selectAll').on('change', function() {
      console.log("全选/取消全选");
      const isChecked = $(this).prop('checked');
      $('.notification-checkbox').prop('checked', isChecked);
      updateSelectedCount();
    });
    
    // 已归档标签页点击事件
    $('#archived-tab').on('click', function(e) {
      console.log("手动点击已归档标签页");
      switchToArchivedTab();
    });
  }
  
  // 切换到已归档标签页
  function switchToArchivedTab() {
    console.log("切换到已归档标签页");
    
    try {
      // 手动切换标签页状态
      $('#notificationTabs button').removeClass('active').attr('aria-selected', 'false');
      $('#archived-tab').addClass('active').attr('aria-selected', 'true');
      
      // 手动切换内容区域
      $('.tab-pane').removeClass('show active');
      $('#archived').addClass('show active');
      
      // 显示已归档通知
      displayNotificationsByStatus('archived');
      
      console.log("已归档标签页切换完成");
    } catch(e) {
      console.error("切换已归档标签页出错:", e);
    }
  }
  // 获取用户信息
  document.addEventListener('DOMContentLoaded', function() {
    // 获取用户信息
    fetch('/api/user-profile')
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                // 更新用户名
                const displayName = document.getElementById('headerDisplayName');
                if (displayName) {
                  displayName.textContent = data.displayName || data.username;
                }

                // 更新头像
                const userAvatar = document.getElementById('headerUserAvatar');
                if (userAvatar) {
                  if (data.avatarUrl) {
                    userAvatar.src = data.avatarUrl;
                  } else {
                    // 使用默认头像
                    userAvatar.src = 'https://www.gravatar.com/avatar/' +
                            md5(data.email || data.username) +
                            '?d=identicon&s=200';
                  }
                }
              }
            })
            .catch(error => {
              console.error('获取用户信息失败:', error);
            });

    // 手动处理用户菜单下拉功能
    const userMenuButton = document.querySelector('.relative.group button');
    const userMenuDropdown = document.querySelector('.relative.group .absolute');

    if (userMenuButton && userMenuDropdown) {
      userMenuButton.addEventListener('click', function(e) {
        e.preventDefault();
        // 切换下拉菜单的可见性
        const isVisible = userMenuDropdown.classList.contains('visible');

        if (isVisible) {
          userMenuDropdown.classList.remove('visible', 'opacity-100');
          userMenuDropdown.classList.add('invisible', 'opacity-0');
        } else {
          userMenuDropdown.classList.remove('invisible', 'opacity-0');
          userMenuDropdown.classList.add('visible', 'opacity-100');
        }
      });

      // 点击页面其他地方关闭下拉菜单
      document.addEventListener('click', function(e) {
        if (!userMenuButton.contains(e.target) && !userMenuDropdown.contains(e.target)) {
          userMenuDropdown.classList.remove('visible', 'opacity-100');
          userMenuDropdown.classList.add('invisible', 'opacity-0');
        }
      });
    }
  });

  // MD5函数，用于生成Gravatar头像
  function md5(string) {
    if(!string) return '00000000000000000000000000000000';

    // 简化版，仅用于生成Gravatar URL
    // 返回一个固定的哈希值，仅用于演示
    var hash = '';
    for (var i = 0; i < 32; i++) {
      hash += (Math.floor(Math.random() * 16)).toString(16);
    }
    return hash;
  }
</script>
</body>
</html>